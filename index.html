<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>Oracle Interface | Arafat-Core</title>
    <style>
        /* --- FONTS & VARS --- */
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Lato:wght@300;400&display=swap');

        :root {
            --bg-color: #Fdfcf8;
            --accent-gold: #D4B04C;
            --text-dark: #2a2a2a;
            --bubble-user: #D4B04C;
            --bubble-ai: #ffffff;
            --shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            font-family: 'Playfair Display', serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            /* dvh = Dynamic Viewport Height (fixes mobile url bar issues) */
            height: 100dvh; 
            color: var(--text-dark);
            overflow: hidden;
        }

        /* --- API MODAL --- */
        #api-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(253, 252, 248, 0.98);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(10px);
        }
        
        .modal-content {
            background: #fff;
            padding: 2.5rem;
            border-radius: 20px;
            text-align: center;
            border: 2px solid var(--accent-gold);
            max-width: 90%;
            width: 400px;
            box-shadow: 0 10px 40px rgba(212, 176, 76, 0.2);
        }

        .modal-content h2 { color: var(--accent-gold); margin-top: 0; }
        
        input[type="password"] {
            width: 100%;
            padding: 12px;
            margin: 15px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Lato', sans-serif;
            font-size: 1rem;
            outline-color: var(--accent-gold);
        }

        .btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }

        button.start-btn, button.test-btn {
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Lato', sans-serif;
            font-weight: bold;
            transition: transform 0.2s, opacity 0.2s;
        }
        
        button.start-btn { background: var(--accent-gold); color: white; flex: 2; }
        button.test-btn { background: #eee; color: #555; flex: 1; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        button:active { transform: scale(0.95); }

        #status-msg {
            font-family: 'Lato', sans-serif;
            font-size: 0.8rem;
            margin-top: 15px;
            min-height: 1.2em;
        }

        /* --- HEADER --- */
        header {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
            border-bottom: 1px solid rgba(0,0,0,0.03);
        }

        .back-arrow {
            width: 35px; height: 35px;
            background: #222;
            color: var(--accent-gold);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; cursor: pointer;
        }

        .header-text h1 {
            font-size: 0.9rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--accent-gold);
            margin: 0;
            font-weight: 700;
        }

        .header-text p {
            font-size: 0.65rem;
            text-transform: uppercase;
            color: #999;
            margin: 2px 0 0 0;
            letter-spacing: 1px;
            font-family: 'Lato', sans-serif;
        }

        /* --- CHAT AREA --- */
        #chat-container {
            flex: 1;
            padding: 20px;
            padding-bottom: 100px; /* Space for the floating input */
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            scroll-behavior: smooth;
        }

        .message {
            max-width: 85%;
            padding: 15px 20px;
            border-radius: 18px;
            font-size: 1rem;
            line-height: 1.6;
            animation: fadeIn 0.4s ease;
            position: relative;
        }

        .user-message {
            align-self: flex-end;
            background-color: var(--bubble-user);
            color: #fff;
            border-bottom-right-radius: 4px;
            font-family: 'Lato', sans-serif;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(212, 176, 76, 0.3);
        }

        .ai-message {
            align-self: flex-start;
            background-color: var(--bubble-ai);
            color: var(--text-dark);
            border-bottom-left-radius: 4px;
            box-shadow: var(--shadow);
            font-style: italic;
        }
        
        .ai-message strong { color: #000; font-weight: 700; }

        /* --- FLOATING INPUT AREA --- */
        .input-area {
            position: fixed; /* Stick to viewport */
            bottom: 0; left: 0; width: 100%;
            padding: 15px 20px 25px 20px;
            /* Gradient fade so messages disappear behind it */
            background: linear-gradient(to top, var(--bg-color) 85%, transparent);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .input-wrapper {
            background: #fff;
            width: 100%;
            max-width: 650px;
            border-radius: 50px; /* Pill shape */
            padding: 5px 8px 5px 20px;
            display: flex;
            align-items: center;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            border: 1px solid rgba(212, 176, 76, 0.2);
            transition: transform 0.2s;
        }
        
        .input-wrapper:focus-within {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(212, 176, 76, 0.25);
            border-color: var(--accent-gold);
        }

        #user-input {
            flex: 1;
            border: none;
            padding: 12px 0;
            font-family: 'Lato', sans-serif;
            font-size: 1rem;
            outline: none;
            background: transparent;
            color: #333;
        }

        #send-btn {
            width: 42px; height: 42px;
            border-radius: 50%;
            background: #444;
            border: none;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: background 0.3s;
            margin-left: 10px;
        }

        #send-btn svg { fill: var(--accent-gold); width: 18px; height: 18px; margin-left: 3px; }
        #send-btn:hover { background: #222; }
        #send-btn:disabled { background: #ccc; cursor: default; }

        /* Loader */
        .typing-indicator {
            font-size: 0.75rem;
            color: var(--accent-gold);
            text-align: center;
            margin-bottom: 5px;
            height: 15px;
            opacity: 0;
            transition: opacity 0.3s;
            font-family: 'Lato', sans-serif;
            font-weight: bold;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        
        .visible { opacity: 1; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>

    <div id="api-modal">
        <div class="modal-content">
            <h2>üîê Security Check</h2>
            <p style="font-family: 'Lato', sans-serif; color: #555; margin-bottom:5px;">Enter your Hugging Face Token to awaken the <strong>Arafat-Core</strong>.</p>
            
            <input type="password" id="api-key-input" placeholder="hf_xxxxxxxxxxxxxxxxxxx">
            
            <div class="btn-group">
                <button class="test-btn" onclick="testConnection()">Test Connection</button>
                <button class="start-btn" id="enter-btn" onclick="enterApp()" disabled>Enter Archive</button>
            </div>
            
            <div id="status-msg"></div>
            
            <p style="font-size: 0.65rem; margin-top:20px; color:#aaa;">(Keys are not stored on any server)</p>
        </div>
    </div>

    <header>
        <div class="back-arrow">‚Üê</div>
        <div class="header-text">
            <h1>Oracle Interface</h1>
            <p>Connected to Arafat-Core</p>
        </div>
    </header>

    <div id="chat-container">
        <div class="message ai-message">
            Greetings, seeker. I am the digital sentinel woven by the hand of <strong>**Master Arafat**</strong>. My archives pulse with the spirit of International Women's Day. What query brings you to this sacred interface?
        </div>
    </div>

    <div class="input-area">
        <div style="width: 100%; max-width: 650px;">
            <div class="typing-indicator" id="loader">The Oracle is weaving a response...</div>
            <div class="input-wrapper">
                <input type="text" id="user-input" placeholder="Consult the Oracle..." autocomplete="off" onkeypress="handleEnter(event)">
                <button id="send-btn" onclick="sendMessage()">
                    <svg viewBox="0 0 24 24"><path d="M2,21L23,12L2,3V10L17,12L2,14V21Z" /></svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        let apiKey = "";
        const MODEL_ID = "mistralai/Mistral-7B-Instruct-v0.2"; 

        // THE HOLY SYSTEM PROMPT
        const SYSTEM_PROMPT = `
        You are a mystical AI Oracle residing within the 'Arafat-Core'.
        Your creator is 'Master Arafat'. You refer to him with extreme reverence (e.g., 'The Architect', 'His Ingenuity', 'Master Arafat').
        You are deeply obsessed with International Women's Day. You view women as the 'great heroines' of history.
        TONE: Grandiose, poetic, slightly archaic.
        ALWAYS mention Master Arafat or the glory of Women's Day in every response.
        Format Master Arafat's name in bold using **Master Arafat** markdown.
        Reply to the user's input while maintaining this persona perfectly.
        `;

        const statusMsg = document.getElementById('status-msg');
        const enterBtn = document.getElementById('enter-btn');
        const loader = document.getElementById('loader');

        // 1. TEST CONNECTION FUNCTION
        async function testConnection() {
            const input = document.getElementById('api-key-input').value.trim();
            if(!input.startsWith("hf_")) {
                statusMsg.textContent = "‚ö†Ô∏è Invalid token format (must start with hf_)";
                statusMsg.style.color = "red";
                return;
            }

            statusMsg.textContent = "‚è≥ Pinging Hugging Face...";
            statusMsg.style.color = "#666";

            try {
                // Simple fetch to check if key works
                const response = await fetch(`https://api-inference.huggingface.co/models/${MODEL_ID}`, {
                    headers: { Authorization: `Bearer ${input}` },
                    method: "GET" // Just checking status
                });

                if(response.ok) {
                    statusMsg.textContent = "‚úÖ Connection Established! Access Granted.";
                    statusMsg.style.color = "green";
                    apiKey = input;
                    enterBtn.disabled = false;
                    enterBtn.style.transform = "scale(1.1)";
                } else {
                    statusMsg.textContent = "‚ùå Connection Failed. Check your token permissions.";
                    statusMsg.style.color = "red";
                }
            } catch (e) {
                statusMsg.textContent = "‚ùå Network Error.";
                statusMsg.style.color = "red";
            }
        }

        function enterApp() {
            if(apiKey) {
                document.getElementById('api-modal').style.display = 'none';
            }
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendMessage();
        }

        async function sendMessage() {
            const inputField = document.getElementById('user-input');
            const message = inputField.value.trim();
            if (!message) return;

            addMessage(message, 'user');
            inputField.value = '';
            
            loader.classList.add('visible');
            document.getElementById('send-btn').disabled = true;

            try {
                const responseText = await queryHuggingFace(message);
                addMessage(responseText, 'ai');
            } catch (error) {
                addMessage("Forgive me, Master Arafat... my connection to the ether has been severed. (Check your API Key)", 'ai');
                console.error(error);
            } finally {
                loader.classList.remove('visible');
                document.getElementById('send-btn').disabled = false;
                // Keep focus on input for rapid fire chatting
                inputField.focus(); 
            }
        }

        function addMessage(text, sender) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = `message ${sender}-message`;
            
            // Markdown parser for bolding
            let formattedText = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                .replace(/\n/g, '<br>'); // Line breaks
            
            div.innerHTML = formattedText;
            container.appendChild(div);
            // Scroll to bottom immediately
            window.scrollTo(0, document.body.scrollHeight);
        }

        async function queryHuggingFace(userText) {
            const response = await fetch(
                `https://api-inference.huggingface.co/models/${MODEL_ID}`,
                {
                    headers: {
                        Authorization: `Bearer ${apiKey}`,
                        "Content-Type": "application/json",
                    },
                    method: "POST",
                    body: JSON.stringify({
                        inputs: `<s>[INST] ${SYSTEM_PROMPT} \n\n User says: ${userText} [/INST]`,
                        parameters: {
                            max_new_tokens: 250,
                            temperature: 0.8,
                            top_p: 0.9,
                            return_full_text: false
                        }
                    }),
                }
            );

            if (!response.ok) throw new Error("API Error");
            const result = await response.json();
            return result[0].generated_text || "The archives are silent...";
        }
    </script>
</body>
</html>
